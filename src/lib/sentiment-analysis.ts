/**
 * 일기 내용에서 감정을 분석하고 적절한 위로 메시지를 제공하는 유틸리티 함수들
 */

// 감정별 키워드 매칭
const emotionKeywords = {
  lonely: ['외로', '혼자', '고독', '쓸쓸', '빈', '텅 빈', '아무도', '누구도'],
  tired: ['지쳐', '피곤', '힘들', '지치', '녹초', '탈진', '번아웃', '에너지'],
  angry: ['화', '짜증', '분노', '열받', '빡쳐', '불쾌', '기분나빠', '화나'],
  anxious: ['불안', '걱정', '초조', '두려', '무서', '염려', '근심', '조바심'],
  unfocused: ['집중', '산만', '흐트', '정신없', '멍하', '딴생각', '헷갈'],
  worried: ['고민', '걱정', '신경쓰', '마음무', '스트레스', '부담'],
  stuck: ['막히', '안풀', '답답', '진척', '막막', '어려', '난관'],
  financial: ['돈', '자금', '경제', '재정', '생활비', '수입', '지출', '빚'],
  giveup: ['포기', '그만두', '때려치', '지쳐', '의욕', '힘빠', '절망'],
  confidence: ['자신감', '자존감', '확신', '믿음', '부족', '없어', '의심'],
  unmotivated: ['의욕', '하기싫', '귀찮', '무기력', '게을', '미루'],
  no_revenue: ['매출', '수익', '벌', '돈', '수입', '실적', '성과'],
  too_much_work: ['일', '업무', '해야할', '바쁘', '과로', '많아', '시간'],
  low_passion: ['열정', '동기', '목표', '의미', '왜', '이유', '방향']
};

// 긍정적 키워드들
const positiveKeywords = ['좋', '행복', '기쁘', '만족', '성취', '뿌듯', '감사', '즐거', '완성', '성공'];

// 감정별 위로 메시지
export const comfortMessages = {
  lonely: [
    "혼자라고 느끼는 지금 이 순간이 당신을 더 강하게 만들고 있어요. 당신은 혼자가 아니에요.",
    "외로움은 당신이 누군가와 깊은 연결을 원한다는 증거예요. 그 마음이 아름다워요.",
    "지금의 고독한 시간이 당신 자신과 더 가까워지는 소중한 기회가 될 거예요.",
    "외로움을 느끼는 것은 당연해요. 당신의 감정을 인정하고 받아들여주세요.",
    "혼자인 시간도 당신만의 특별한 시간이에요. 스스로를 돌보는 시간으로 만들어보세요."
  ],
  tired: [
    "지친 몸과 마음을 충분히 쉬게 해주세요. 당신이 쉴 자격이 있어요.",
    "피곤한 것은 당신이 열심히 살아왔다는 증거예요. 잠시 멈춰도 괜찮아요.",
    "지금은 재충전의 시간이에요. 천천히 에너지를 회복해나가세요.",
    "지친 오늘 하루도 최선을 다한 당신이 대단해요. 이제 푹 쉬세요.",
    "피로는 당신이 성장하고 있다는 신호일 수도 있어요. 충분히 휴식하세요."
  ],
  angry: [
    "화가 나는 것은 당연한 감정이에요. 그 감정을 인정하고 건강하게 표현해보세요.",
    "분노 뒤에 숨은 진짜 감정을 찾아보세요. 당신의 마음을 이해해주세요.",
    "화가 날 때일수록 천천히 깊게 숨을 쉬어보세요. 마음이 차분해질 거예요.",
    "지금의 분노도 지나갈 거예요. 시간이 해결해줄 많은 것들이 있어요.",
    "화를 내는 것보다 스스로를 진정시키는 것이 더 큰 힘이에요."
  ],
  anxious: [
    "불안한 마음을 달래주세요. 당신이 걱정하는 많은 일들은 일어나지 않을 거예요.",
    "불안함을 느끼는 것은 당신이 신중하고 책임감 있다는 증거예요.",
    "지금 이 순간에 집중해보세요. 현재에 머무르면 불안이 줄어들 거예요.",
    "불안할 때일수록 작은 것부터 차근차근 해보세요. 한 걸음씩이면 충분해요.",
    "당신이 걱정하는 것들, 대부분은 당신이 충분히 해낼 수 있는 일들이에요."
  ],
  unfocused: [
    "집중이 안 되는 날도 있어요. 무리하지 말고 편안한 마음으로 지내세요.",
    "산만한 마음도 창의성의 표현일 수 있어요. 다양한 생각들을 받아들여보세요.",
    "집중력이 떨어졌다면 잠시 휴식이 필요한 신호일 수 있어요.",
    "완벽하게 집중할 필요는 없어요. 조금씩이라도 전진하고 있다면 충분해요.",
    "마음이 흩어져 있을 때는 명상이나 가벼운 운동을 해보세요."
  ],
  worried: [
    "고민이 많은 당신의 마음이 이해돼요. 혼자서 모든 걱정을 짊어지지 마세요.",
    "고민은 당신이 신중하게 생각하고 있다는 증거예요. 그 자체로 훌륭해요.",
    "모든 문제에는 해결책이 있어요. 시간을 갖고 차근차근 풀어나가세요.",
    "고민할 때일수록 신뢰할 수 있는 사람과 이야기를 나눠보세요.",
    "지금의 고민들도 언젠가는 추억이 될 거예요. 너무 무겁게 생각하지 마세요."
  ],
  stuck: [
    "막힌 길에서 잠시 멈춰 서는 것도 괜찮아요. 새로운 길을 찾을 시간이에요.",
    "지금 안 풀리는 일들도 시간이 지나면 해결될 거예요. 조급해하지 마세요.",
    "다른 관점에서 문제를 바라보면 새로운 해결책이 보일 거예요.",
    "막막할 때일수록 가장 작은 한 걸음부터 시작해보세요.",
    "모든 성공한 사람들도 이런 막막한 순간들을 겪어왔어요. 당신도 해낼 수 있어요."
  ],
  financial: [
    "경제적 어려움은 일시적이에요. 당신의 가치는 돈으로 측정되지 않아요.",
    "지금은 힘들어도 현명하게 관리하면 상황이 나아질 거예요.",
    "돈의 부족함보다 당신이 가진 것들에 집중해보세요.",
    "경제적 스트레스를 느끼는 것은 당연해요. 스스로를 너무 탓하지 마세요.",
    "작은 절약부터 시작해보세요. 작은 변화들이 큰 차이를 만들어요."
  ],
  giveup: [
    "포기하고 싶을 때가 진짜 시작인 경우가 많아요. 조금만 더 버텨보세요.",
    "지금까지 온 길을 돌아보세요. 당신은 이미 충분히 강한 사람이에요.",
    "포기는 언제든 할 수 있어요. 오늘 하루만 더 해보는 건 어떨까요?",
    "힘들 때일수록 도움을 요청하는 것이 현명해요. 혼자가 아니라는 걸 기억하세요.",
    "지금의 어려움이 당신을 더 강하고 지혜로운 사람으로 만들고 있어요."
  ],
  confidence: [
    "자신감은 하루아침에 생기지 않아요. 작은 성취들을 쌓아가세요.",
    "당신이 생각하는 것보다 당신은 훨씬 훌륭한 사람이에요.",
    "자신감이 없을 때일수록 당신이 해낸 일들을 떠올려보세요.",
    "완벽하지 않아도 괜찮아요. 있는 그대로의 당신도 충분히 가치 있어요.",
    "다른 사람과 비교하지 마세요. 당신만의 속도로 성장해나가세요."
  ],
  unmotivated: [
    "의욕이 없는 날도 있어요. 무리하지 말고 몸과 마음을 쉬게 해주세요.",
    "동기가 부족할 때는 아주 작은 것부터 시작해보세요.",
    "무기력한 기분도 지나갈 거예요. 지금은 재충전의 시간이라고 생각하세요.",
    "매일 의욕적일 필요는 없어요. 인간다운 감정을 받아들여주세요.",
    "작은 성취라도 스스로를 격려해주세요. 그것이 다시 일어설 힘이 돼요."
  ],
  no_revenue: [
    "매출은 실력의 전부를 말해주지 않아요. 꾸준히 노력하는 당신이 대단해요.",
    "지금의 경험들이 나중에 큰 자산이 될 거예요. 포기하지 마세요.",
    "매출이 없어도 당신의 가치는 변하지 않아요. 자신감을 잃지 마세요.",
    "모든 성공한 사업가들도 이런 시기를 겪었어요. 당신도 해낼 수 있어요.",
    "지금은 씨앗을 뿌리는 시기일 수 있어요. 언젠가 열매를 맺을 거예요."
  ],
  too_much_work: [
    "할 일이 많을 때일수록 우선순위를 정하고 하나씩 처리해보세요.",
    "모든 일을 완벽하게 할 필요는 없어요. 중요한 것부터 차근차근 해보세요.",
    "바쁜 것도 당신이 필요한 사람이라는 증거예요. 스스로를 격려해주세요.",
    "때로는 도움을 요청하거나 일을 위임하는 것도 현명한 선택이에요.",
    "오늘 하루만 집중해보세요. 내일 걱정은 내일 해도 늦지 않아요."
  ],
  low_passion: [
    "열정이 식었다고 느껴도 괜찮아요. 잠시 쉬어가는 시간일 수 있어요.",
    "처음 시작했을 때의 마음을 떠올려보세요. 그 이유가 아직 유효한지 생각해보세요.",
    "열정은 파도처럼 밀려왔다 빠져나가요. 다시 돌아올 때까지 기다려보세요.",
    "새로운 관점이나 목표를 찾아보는 것도 좋은 방법이에요.",
    "열정이 없어도 꾸준함이 있다면 충분해요. 당신은 이미 잘하고 있어요."
  ],
  happy: [
    "행복한 기분을 마음껏 즐기세요! 이런 순간들이 삶을 아름답게 만들어요.",
    "좋은 날을 보내고 계시는군요! 이 기쁨을 오래 간직하세요.",
    "행복한 감정을 느끼는 당신이 멋져요. 긍정적인 에너지를 나누어주세요.",
    "기쁜 마음이 전해져요! 이런 순간들을 소중히 여기세요.",
    "행복한 하루네요! 이 좋은 기운이 계속 이어지길 바라요."
  ],
  grateful: [
    "감사하는 마음을 가진 당신이 아름다워요. 그 마음이 더 많은 행복을 가져올 거예요.",
    "감사의 감정을 느끼고 계시는군요. 이런 마음이 삶을 더욱 풍요롭게 만들어요.",
    "고마워하는 마음을 갖는 것만으로도 당신은 행복에 한 걸음 더 가까워져요.",
    "감사할 줄 아는 마음이 당신의 가장 큰 자산이에요.",
    "감사의 마음이 더 많은 좋은 일들을 끌어올 거예요."
  ]
};

/**
 * 일기 내용에서 감정을 분석하는 함수
 */
export function analyzeSentiment(
  selectedEmotion: string,
  answers: Record<string, string>,
  personalMessage?: string
): string[] {
  // 전체 텍스트 결합
  const allText = Object.values(answers).join(' ') + (personalMessage || '');
  const lowerText = allText.toLowerCase();

  // 선택된 감정을 기본으로 하되, 텍스트 분석으로 보완
  const detectedEmotions: string[] = [selectedEmotion];
  
  // 긍정적 키워드 체크
  const hasPositiveKeywords = positiveKeywords.some(keyword => 
    lowerText.includes(keyword)
  );
  
  if (hasPositiveKeywords) {
    if (lowerText.includes('감사') || lowerText.includes('고마')) {
      detectedEmotions.push('grateful');
    } else {
      detectedEmotions.push('happy');
    }
  }

  // 다른 감정 키워드들도 체크하여 복합 감정 탐지
  Object.entries(emotionKeywords).forEach(([emotion, keywords]) => {
    if (emotion === selectedEmotion) return; // 이미 선택된 감정은 스킵
    
    const keywordCount = keywords.filter(keyword => 
      lowerText.includes(keyword)
    ).length;
    
    // 2개 이상의 키워드가 매칭되면 해당 감정도 포함
    if (keywordCount >= 2) {
      detectedEmotions.push(emotion);
    }
  });

  return detectedEmotions;
}

/**
 * 감정에 따른 위로 메시지를 가져오는 함수
 */
export function getComfortMessage(emotions: string[]): string {
  // 주요 감정 (첫 번째)에 해당하는 메시지를 우선적으로 선택
  const primaryEmotion = emotions[0];
  const messages = comfortMessages[primaryEmotion as keyof typeof comfortMessages];
  
  if (!messages || messages.length === 0) {
    // 기본 메시지
    return "오늘 하루도 고생 많았어요. 당신의 솔직한 마음을 나누어주셔서 감사해요. 내일은 더 나은 하루가 될 거예요.";
  }
  
  // 랜덤하게 메시지 선택
  const randomIndex = Math.floor(Math.random() * messages.length);
  return messages[randomIndex];
}

/**
 * 일기 내용에 따른 개인화된 응답을 생성하는 함수
 */
export function generatePersonalizedResponse(
  selectedEmotion: string,
  answers: Record<string, string>,
  personalMessage?: string
): {
  emotions: string[];
  comfortMessage: string;
  encouragement: string;
} {
  const emotions = analyzeSentiment(selectedEmotion, answers, personalMessage);
  const comfortMessage = getComfortMessage(emotions);
  
  // 감정에 따른 격려 메시지
  const encouragements = {
    lonely: "혼자가 아니에요. 당신을 생각하는 사람들이 있어요.",
    tired: "충분히 쉬세요. 당신은 휴식할 자격이 있어요.",
    angry: "화가 나는 것도 괜찮아요. 감정을 인정해주세요.",
    anxious: "괜찮을 거예요. 한 걸음씩 나아가세요.",
    unfocused: "완벽하지 않아도 돼요. 조금씩 해나가세요.",
    worried: "모든 문제에는 해결책이 있어요.",
    stuck: "새로운 길이 보일 거예요. 조금만 기다려보세요.",
    financial: "당신의 가치는 돈으로 측정되지 않아요.",
    giveup: "지금까지 온 길을 돌아보세요. 당신은 강한 사람이에요.",
    confidence: "있는 그대로의 당신도 충분히 훌륭해요.",
    unmotivated: "쉬어도 괜찮아요. 무기력함도 자연스러운 감정이에요.",
    no_revenue: "꾸준히 노력하는 당신이 대단해요.",
    too_much_work: "우선순위를 정하고 하나씩 처리해보세요.",
    low_passion: "열정은 다시 돌아올 거예요.",
    happy: "이 행복한 순간을 만끽하세요!",
    grateful: "감사하는 마음이 더 많은 행복을 가져올 거예요."
  };
  
  const encouragement = encouragements[emotions[0] as keyof typeof encouragements] || 
    "오늘도 최선을 다한 당신이 자랑스러워요.";
  
  return {
    emotions,
    comfortMessage,
    encouragement
  };
}
